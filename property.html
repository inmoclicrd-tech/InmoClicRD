<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Propiedad - InmoClicRD</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* --- ARREGLO DEL LOGO --- */
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: white !important;
            text-decoration: none !important;
            display: flex;
            align-items: center;
        }
        .logo:hover { opacity: 0.9; }

        /* --- ESTILOS DEL DETALLE --- */
        .property-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .property-grid {
                grid-template-columns: 1fr;
            }
        }

        #main-display {
            width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: 12px;
            background-color: #eee;
            display: block;
        }

        .thumb-img {
            width: 80px; height: 60px;
            object-fit: cover; border-radius: 6px;
            cursor: pointer; border: 2px solid transparent;
            transition: border 0.2s; flex-shrink: 0;
        }
        .thumb-img:hover { border-color: var(--primary); }

        .side-card {
            background: white; padding: 25px;
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            position: sticky; top: 20px;
        }

        .feature-item {
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 10px; color: #555;
        }

        .publisher-box {
            background: #f8f9fa; padding: 15px;
            border-radius: 8px; margin: 20px 0; border: 1px solid #eee;
        }

        /* --- ESTILOS DEL MODAL DE REPORTE (CORREGIDO) --- */
        .modal-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center; align-items: center;
        }

        .modal-box {
            background: white; padding: 30px;
            border-radius: 12px; width: 90%; max-width: 450px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
        }

        .modal-title { margin-bottom: 20px; color: #c0392b; font-size: 1.3rem; }

        /* --- AQU√ç EST√Å EL ARREGLO DE ALINEACI√ìN --- */
        .report-option {
            display: flex; /* Usamos Flexbox para alinear */
            align-items: center; /* Centrar verticalmente */
            gap: 10px; /* Espacio entre el c√≠rculo y el texto */
            margin-bottom: 15px; /* Espacio entre opciones */
            cursor: pointer;
            font-size: 1rem; color: #333;
            background: #f9f9f9; /* Fondo suave para que parezca bot√≥n */
            padding: 10px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .report-option:hover {
            background: #eee;
        }

        /* Ajuste del input (c√≠rculo) para que no se deforme */
        .report-option input[type="radio"] {
            margin: 0;
            width: 18px;
            height: 18px;
            accent-color: #c0392b; /* Color rojo al seleccionar */
            cursor: pointer;
        }
        /* ------------------------------------------ */

        .report-textarea {
            width: 100%; padding: 10px; border: 1px solid #ddd;
            border-radius: 8px; margin-top: 10px; display: none;
            font-family: inherit;
        }

        .modal-actions {
            display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;
        }

        .btn-cancel {
            background: #eee; color: #333; border: none;
            padding: 10px 20px; border-radius: 6px; cursor: pointer;
        }
        .btn-confirm {
            background: #c0392b; color: white; border: none;
            padding: 10px 20px; border-radius: 6px; cursor: pointer;
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="container header-content" style="display: flex; justify-content: space-between; align-items: center;">
            <a href="index.html" class="logo">InmoClicRD</a>
            <a href="index.html" class="btn-secondary">Volver</a>
        </div>
    </header>

    <main class="container">
        <div class="property-grid">
            <div class="main-column">
                <div class="gallery-container">
                    <img id="main-display" src="https://via.placeholder.com/800x600?text=Cargando..." alt="Imagen Principal">
                    <div id="thumb-list" style="display:flex; gap:10px; margin-top:15px; overflow-x:auto; padding-bottom:10px;"></div>
                </div>

                <div style="background:white; padding:25px; border-radius:12px; margin-top:20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                    <h3 style="margin-bottom: 15px;">Descripci√≥n</h3>
                    <p id="prop-desc" style="white-space: pre-line; color: #444; line-height: 1.6;">Cargando descripci√≥n...</p>
                </div>
            </div>

            <div class="side-panel">
                <div class="side-card">
                    <button id="btn-report-trigger" style="float:right; border:none; background:none; color:#e74c3c; cursor:pointer; font-size: 0.9rem;">üö© Reportar</button>

                    <h1 id="prop-title" style="font-size:1.4rem; margin-bottom: 5px; line-height: 1.3;">Cargando t√≠tulo...</h1>
                    <p id="prop-location" style="color:#666; font-size: 0.95rem; margin-bottom: 15px;">üìç ...</p>

                    <h2 id="prop-price" style="color: #1dd1a1; font-size:1.8rem; margin-bottom: 20px;">RD$ ...</h2>

                    <div class="features-list" style="border-top:1px solid #eee; padding-top:15px; margin-bottom: 15px;">
                        <div class="feature-item" id="feat-rooms">üõèÔ∏è -- Hab</div>
                        <div class="feature-item" id="feat-baths">üöø -- Ba√±os</div>
                        <div class="feature-item" id="feat-parking">üöó -- Pq</div>
                    </div>

                    <div class="publisher-box">
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 5px;">Publicado por:</p>
                        <h3 style="font-size: 1.1rem; color: #333; display: flex; align-items: center; gap: 8px;">
                            üë§ <span id="publisher-name">Cargando...</span>
                        </h3>
                    </div>

                    <a id="whatsapp-link" href="#" target="_blank" class="btn-primary" style="display:block; text-align:center; padding:15px; background:#25D366; text-decoration:none; border-radius: 8px; font-weight: bold;">
                        üì≤ Contactar por WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </main>

    <div id="report-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">üö© Reportar publicaci√≥n</h3>
            <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">Selecciona el motivo del reporte. Esto ser√° revisado por nuestro equipo.</p>

            <form id="report-form">
                <label class="report-option">
                    <input type="radio" name="motivo" value="Informaci√≥n falsa" required> Informaci√≥n falsa
                </label>
                <label class="report-option">
                    <input type="radio" name="motivo" value="Im√°genes no claras"> Im√°genes no claras
                </label>
                <label class="report-option">
                    <input type="radio" name="motivo" value="Precios falsos"> Precios falsos
                </label>
                <label class="report-option">
                    <input type="radio" name="motivo" value="Otro" id="radio-otro"> Otro (Especifique)
                </label>

                <textarea id="report-text" class="report-textarea" rows="3" placeholder="Describe el problema aqu√≠..."></textarea>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="btn-close-modal">Cancelar</button>
                    <button type="submit" class="btn-confirm">Enviar Reporte</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"; // Para saber qui√©n reporta

        const firebaseConfig = {
            apiKey: "AIzaSyADDo7xxarlsQcZ37ZEQRBaM1U_rVm8ngg",
            authDomain: "inmoclicrd-e58e8.firebaseapp.com",
            projectId: "inmoclicrd-e58e8",
            storageBucket: "inmoclicrd-e58e8.firebasestorage.app",
            messagingSenderId: "780365012646",
            appId: "1:780365012646:web:2e0feff94c426f8287de67"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const propertyId = new URLSearchParams(window.location.search).get("id");

        // --- L√ìGICA DEL MODAL ---
        const modal = document.getElementById("report-modal");
        const btnTrigger = document.getElementById("btn-report-trigger");
        const btnClose = document.getElementById("btn-close-modal");
        const reportForm = document.getElementById("report-form");
        const radioOtro = document.getElementById("radio-otro");
        const textArea = document.getElementById("report-text");
        const radios = document.getElementsByName("motivo");

        // Abrir Modal
        btnTrigger.addEventListener("click", () => {
            modal.style.display = "flex";
        });

        // Cerrar Modal
        btnClose.addEventListener("click", () => {
            modal.style.display = "none";
            reportForm.reset();
            textArea.style.display = "none";
        });

        // Mostrar/Ocultar textarea si elige "Otro"
        radios.forEach(radio => {
            radio.addEventListener("change", (e) => {
                if(e.target.value === "Otro") {
                    textArea.style.display = "block";
                    textArea.required = true;
                } else {
                    textArea.style.display = "none";
                    textArea.required = false;
                }
            });
        });

        // Enviar Reporte
        reportForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Obtener motivo seleccionado
            let motivoFinal = "";
            const selected = document.querySelector('input[name="motivo"]:checked');
            if(selected) {
                if(selected.value === "Otro") {
                    motivoFinal = "Otro: " + textArea.value;
                } else {
                    motivoFinal = selected.value;
                }
            }

            try {
                const btnSubmit = reportForm.querySelector(".btn-confirm");
                const originalText = btnSubmit.innerText;
                btnSubmit.innerText = "Enviando...";
                btnSubmit.disabled = true;

                // Guardar en Firebase (Colecci√≥n 'reports')
                // NOTA SOBRE CORREO: Para recibir esto por correo, en el futuro puedes
                // instalar la extensi√≥n 'Trigger Email' de Firebase en la consola
                // que escucha esta colecci√≥n 'reports' y env√≠a el mail autom√°ticamente.
                await addDoc(collection(db, "reports"), {
                    propertyId: propertyId,
                    motivo: motivoFinal,
                    tituloPropiedad: document.getElementById("prop-title").innerText,
                    precioPropiedad: document.getElementById("prop-price").innerText,
                    fecha: new Date(),
                    // Si el usuario que reporta est√° logueado, guardamos sus datos
                    reportadoPor: auth.currentUser ? auth.currentUser.email : "Visitante an√≥nimo",
                    status: "pendiente"
                });

                alert("‚úÖ Reporte enviado correctamente. Nuestro equipo revisar√° la publicaci√≥n.");
                modal.style.display = "none";
                reportForm.reset();
                btnSubmit.innerText = originalText;
                btnSubmit.disabled = false;

            } catch (error) {
                console.error("Error reportando:", error);
                alert("Error al enviar el reporte.");
            }
        });

        // --- CARGA DE DATOS DE LA PROPIEDAD ---
        async function load() {
            if (!propertyId) {
                alert("No se especific√≥ una propiedad.");
                window.location.href = "index.html";
                return;
            }

            try {
                const snap = await getDoc(doc(db, "properties", propertyId));

                if (snap.exists()) {
                    const p = snap.data();

                    document.getElementById("prop-title").innerText = p.title;
                    document.getElementById("prop-price").innerText = `RD$ ${Number(p.price).toLocaleString()}`;
                    document.getElementById("prop-location").innerText = `üìç ${p.city}`;
                    document.getElementById("prop-desc").innerText = p.desc || "Sin descripci√≥n.";

                    document.getElementById("feat-rooms").innerText = `üõèÔ∏è ${p.rooms} Hab`;
                    document.getElementById("feat-baths").innerText = `üöø ${p.baths} Ba√±os`;
                    document.getElementById("feat-parking").innerText = `üöó ${p.parking} Pq`;

                    document.getElementById("publisher-name").innerText = p.userName || "Usuario InmoClic";

                    const wsNumber = p.whatsapp || "18090000000";
                    const cleanNumber = wsNumber.replace(/\D/g, '');
                    document.getElementById("whatsapp-link").href = `https://wa.me/${cleanNumber}?text=Hola, vi tu anuncio "${p.title}" en InmoClicRD y me interesa m√°s informaci√≥n.`;

                    const mainImg = document.getElementById("main-display");
                    const thumbList = document.getElementById("thumb-list");

                    if(p.images && p.images.length > 0) {
                        mainImg.src = p.images[0];
                        p.images.forEach(url => {
                            const img = document.createElement("img");
                            img.src = url;
                            img.className = "thumb-img";
                            img.onclick = () => mainImg.src = url;
                            thumbList.appendChild(img);
                        });
                    } else {
                        mainImg.src = "https://via.placeholder.com/800x600?text=Sin+Imagen";
                    }

                } else {
                    document.querySelector(".container").innerHTML = "<h2 style='text-align:center; margin-top:50px;'>Propiedad no encontrada o eliminada.</h2>";
                }
            } catch (error) {
                console.error("Error cargando propiedad:", error);
                alert("Hubo un error al cargar los datos.");
            }
        }

        load();
    </script>
</body>
</html>