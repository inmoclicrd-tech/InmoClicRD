<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Propiedad - InmoClicRD</title>

    <meta property="og:type" content="website">
    <meta id="meta-title" property="og:title" content="InmoClicRD | Propiedad">
    <meta id="meta-desc" property="og:description" content="Mira los detalles de esta propiedad en InmoClicRD.">
    <meta id="meta-img" property="og:image" content="https://inmoclicrd.com/logo-preview.png">

    <link rel="stylesheet" href="styles.css">
    <style>
        .logo { font-size: 1.5rem; font-weight: bold; color: white !important; text-decoration: none !important; display: flex; align-items: center; }

        /* Layout responsivo */
        .property-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-top: 20px; }

        @media (max-width: 768px) {
            .property-grid { grid-template-columns: 1fr; gap: 15px; }
            #main-display { height: 300px !important; } /* Altura m√°s c√≥moda en m√≥vil */
            .side-card { position: relative !important; top: 0 !important; padding: 20px !important; }
            .modal-box { width: 95%; padding: 20px; }
        }

        #main-display { width: 100%; height: 450px; object-fit: cover; border-radius: 12px; background-color: #eee; display: block; }

        .thumb-img { width: 80px; height: 60px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: border 0.2s; flex-shrink: 0; }
        .thumb-img:hover { border-color: var(--primary); }

        .side-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: sticky; top: 20px; }

        .feature-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; color: #555; }

        .publisher-box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #eee; }

        /* Estilos del Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-title { margin-bottom: 20px; color: #c0392b; font-size: 1.3rem; }

        .report-option { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer; font-size: 1rem; color: #333; background: #f9f9f9; padding: 12px; border-radius: 8px; }
        .report-option input { width: 18px; height: 18px; accent-color: #c0392b; }

        .report-textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 10px; display: none; font-family: inherit; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .btn-cancel { background: #eee; color: #333; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-confirm { background: #c0392b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>

    <header class="header">
        <div class="container header-content" style="display: flex; justify-content: space-between; align-items: center;">
            <a href="index.html" class="logo">InmoClicRD</a>
            <a href="index.html" class="btn-secondary">Volver</a>
        </div>
    </header>

    <main class="container">
        <div class="property-grid">
            <div class="main-column">
                <div class="gallery-container">
                    <img id="main-display" src="https://via.placeholder.com/800x600?text=Cargando..." alt="Imagen Principal">
                    <div id="thumb-list" style="display:flex; gap:10px; margin-top:15px; overflow-x:auto; padding-bottom:10px; -webkit-overflow-scrolling: touch;"></div>
                </div>

                <div style="background:white; padding:25px; border-radius:12px; margin-top:20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                    <h3 style="margin-bottom: 15px;">Descripci√≥n</h3>
                    <p id="prop-desc" style="white-space: pre-line; color: #444; line-height: 1.6;"></p>
                </div>
            </div>

            <div class="side-panel">
                <div class="side-card">
                    <button id="btn-report-trigger" style="float:right; border:none; background:none; color:#e74c3c; cursor:pointer; font-size: 0.9rem;">üö© Reportar</button>

                    <h1 id="prop-title" style="font-size:1.4rem; margin-bottom: 5px; line-height: 1.3;">Cargando...</h1>
                    <p id="prop-location" style="color:#666; font-size: 0.95rem; margin-bottom: 15px;"></p>

                    <h2 id="prop-price" style="color: var(--primary); font-size:1.8rem; margin-bottom: 20px;">RD$ 0</h2>

                    <div class="features-list" style="border-top:1px solid #eee; padding-top:15px; margin-bottom: 15px;">
                        <div class="feature-item" id="feat-rooms">üõèÔ∏è -- Hab</div>
                        <div class="feature-item" id="feat-baths">üöø -- Ba√±os</div>
                        <div class="feature-item" id="feat-parking">üöó -- Pq</div>
                    </div>

                    <div class="publisher-box">
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 5px;">Publicado por:</p>
                        <h3 style="font-size: 1.1rem; color: #333; display: flex; align-items: center; gap: 8px;">
                            üë§ <span id="publisher-name">...</span>
                        </h3>
                    </div>

                    <a id="whatsapp-link" href="#" target="_blank" class="btn-primary" style="display:block; text-align:center; padding:18px; background:#25D366; text-decoration:none; border-radius: 8px; font-weight: bold; font-size: 1.1rem;">
                        üì≤ Contactar por WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </main>

    <div id="report-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">üö© Reportar publicaci√≥n</h3>
            <form id="report-form">
                <label class="report-option"><input type="radio" name="motivo" value="Informaci√≥n falsa" required> Informaci√≥n falsa</label>
                <label class="report-option"><input type="radio" name="motivo" value="Im√°genes no claras"> Im√°genes no claras</label>
                <label class="report-option"><input type="radio" name="motivo" value="Precios falsos"> Precios falsos</label>
                <label class="report-option"><input type="radio" name="motivo" value="Otro" id="radio-otro"> Otro (Especifique)</label>
                <textarea id="report-text" class="report-textarea" rows="3" placeholder="Describe el problema..."></textarea>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="btn-close-modal">Cancelar</button>
                    <button type="submit" class="btn-confirm">Enviar</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyADDo7xxarlsQcZ37ZEQRBaM1U_rVm8ngg",
            authDomain: "inmoclicrd-e58e8.firebaseapp.com",
            projectId: "inmoclicrd-e58e8",
            storageBucket: "inmoclicrd-e58e8.firebasestorage.app",
            messagingSenderId: "780365012646",
            appId: "1:780365012646:web:2e0feff94c426f8287de67"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const propertyId = new URLSearchParams(window.location.search).get("id");

        // L√≥gica Modal
        const modal = document.getElementById("report-modal");
        const btnTrigger = document.getElementById("btn-report-trigger");
        const btnClose = document.getElementById("btn-close-modal");
        const reportForm = document.getElementById("report-form");
        const radioOtro = document.getElementById("radio-otro");
        const textArea = document.getElementById("report-text");

        btnTrigger.onclick = () => modal.style.display = "flex";
        btnClose.onclick = () => { modal.style.display = "none"; reportForm.reset(); textArea.style.display = "none"; };

        document.getElementsByName("motivo").forEach(r => {
            r.onchange = (e) => textArea.style.display = (e.target.value === "Otro") ? "block" : "none";
        });

        reportForm.onsubmit = async (e) => {
            e.preventDefault();
            const selected = document.querySelector('input[name="motivo"]:checked').value;
            const motivoFinal = selected === "Otro" ? `Otro: ${textArea.value}` : selected;
            await addDoc(collection(db, "reports"), {
                propertyId, motivo: motivoFinal, fecha: new Date(),
                reportadoPor: auth.currentUser ? auth.currentUser.email : "An√≥nimo"
            });
            alert("Reporte enviado.");
            modal.style.display = "none";
        };

        async function load() {
            if (!propertyId) return window.location.href = "index.html";

            try {
                const snap = await getDoc(doc(db, "properties", propertyId));
                if (snap.exists()) {
                    const p = snap.data();

                    // Meta Tags
                    document.title = `${p.title} - InmoClicRD`;
                    document.getElementById("meta-title").content = p.title;
                    document.getElementById("meta-desc").content = `RD$ ${Number(p.price).toLocaleString()} - ${p.city}.`;
                    if(p.images?.length) document.getElementById("meta-img").content = p.images[0];

                    document.getElementById("prop-title").innerText = p.title;
                    document.getElementById("prop-price").innerText = `RD$ ${Number(p.price).toLocaleString()}`;
                    document.getElementById("prop-location").innerText = `üìç ${p.city}`;
                    document.getElementById("prop-desc").innerText = p.desc || "";
                    document.getElementById("feat-rooms").innerText = `üõèÔ∏è ${p.rooms} Hab`;
                    document.getElementById("feat-baths").innerText = `üöø ${p.baths} Ba√±os`;
                    document.getElementById("feat-parking").innerText = `üöó ${p.parking} Pq`;
                    document.getElementById("publisher-name").innerText = p.userName || "Usuario";

                    // --- CORRECCI√ìN WHATSAPP (C√ìDIGO PA√çS) ---
                    let rawNum = p.whatsapp || "8090000000";
                    let cleanNumber = rawNum.replace(/\D/g, '');

                    // Si el n√∫mero es dominicano (10 d√≠gitos) y no tiene el '1', se lo agregamos
                    if (cleanNumber.length === 10 && (cleanNumber.startsWith('809') || cleanNumber.startsWith('829') || cleanNumber.startsWith('849'))) {
                        cleanNumber = "1" + cleanNumber;
                    }

                    const message = encodeURIComponent(`Hola, vi este anuncio en InmoClicRD:\n*${p.title}*\nüí∞ RD$ ${Number(p.price).toLocaleString()}\nüìç ${p.city}\nüîó ${window.location.href}`);
                    document.getElementById("whatsapp-link").href = `https://wa.me/${cleanNumber}?text=${message}`;

                    // Galer√≠a
                    const mainImg = document.getElementById("main-display");
                    const thumbList = document.getElementById("thumb-list");
                    if(p.images?.length) {
                        mainImg.src = p.images[0];
                        p.images.forEach(url => {
                            const img = document.createElement("img");
                            img.src = url;
                            img.className = "thumb-img";
                            img.onclick = () => mainImg.src = url;
                            thumbList.appendChild(img);
                        });
                    }
                }
            } catch (error) { console.error(error); }
        }
        load();
    </script>
</body>
</html>